<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">

<script src="../node_modules/redux/dist/redux.js"></script>

<script>
 const reducer = (state, action) => {
	  switch (action.type) {
	    case 'WEBSOCKET_MESSAGE':
			 //console.log('message', action.message)
			 try {
				 var msg = JSON.parse(action.message)
				 if ( msg.test_id ) {
					 //console.log('existing state:', state)
					 var is_result = false;
					 state.tests.forEach(function (t) {						 
						 if ( t.test_id == msg.test_id ) {							 
							 is_result = true
							 console.log('update:', msg.test_id)
						 }						 
					 })
					 if ( !is_result ) {
						 var nt = state.tests.slice(0);
						 nt.push({test_id: msg.test_id, results: [] })
						 return Object.assign({}, state, { tests: nt });	 
					 } else {
						 var nr = state.results.slice(0);
						 nr.unshift(msg)
						 return Object.assign({}, state, { results: nr });
					 }
					 
				 } else {
					 return Object.assign({}, state, msg);	 
				 }				 
			 } catch (err) {
				 console.log(err, action)
			 }
			 return state;
	    case 'WEBSOCKET_READY':
	    	 return Object.assign({}, state, { readyState: action.readyState });
	    case 'WEBSOCKET_REQUEST':
	    	const requests = state.requests.splice(0)
			requests.push(action.request)	    	 			      
	    	return Object.assign({}, state, { requests });	    	 
	    default:
	      return state;
	  }
  };
 
 const store = Redux.createStore(reducer, {
	 requests: [],
	 tests: [],
	 results: []
 });	            
 const ReduxMixin = PolymerRedux(store)
    
 const SelectedMixin = Parent => class SelectedMixin extends ReduxMixin(Parent) {
    
	static get properties() {
      return {
      }
    }
    
    static get actions() {
       return {
       };
     }      
 } 
</script>

