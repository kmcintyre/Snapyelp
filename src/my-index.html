<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">


<link rel="import" href="shared-styles.html">
<link rel="import" href="redux-mixin.html">

<dom-module id="my-index">
   <template>
      <style include="shared-styles iron-flex iron-flex-alignment paper-styles">
         :host {
         
         }
         paper-fab {
         	background-color: #393A3D;
         }
         paper-fab[action="add"] {
         	background-color: #2CA01C;
         }
	     paper-input {
	        --paper-input-container-color: #000;
	        --paper-input-container-focus-color: #538700;
	        --paper-input-container-invalid-color: red;
	        --paper-input-container-input-color: #000;
	     }		 
	     paper-fab {
	     	margin-left: 5px
	     }
		 .job {
		 	@apply(--layout-horizontal);
		 	@apply(--layout-start);		 			 
		 }	     
		 .container {		 	
		 	padding: 10px;
		 	maring: 10px 30px 10px 30px;		 	
		 }
		 .container {
    		@apply(--layout-horizontal);
    		@apply(--layout-wrap);
    	 }
    	 .inner {
    			@apply(--layout-horizontal);    		    		      	
		 }
		 [hidden] {
	     	display: none !important;
		 }
		 .card-content {
		 	min-height: 100px;
		 	width: 300px;
		 }
		.with-margin {
		   --paper-card:{
		    margin: 10px;
		   }
		 } 
      </style>
        <div class="job">
		  	<div class="container">
				<template is="dom-repeat" items="[[job]]" as="step">
					<paper-card class="with-margin">
					  <div class="card-content">
					    <paper-input
		      				label="URL"
							value$="{{ step.url }}"
							on-change="modstep"
							index$="{{ index }}"
							action="update"
						>				    
					    </div>
					  </div>
					  <div class="card-actions">
					    <div class="layout horizontal justified">
								<paper-fab
									hidden$="{{ !step.left }}"
									mini 
									icon="[[left.icon]]" 
									title="[[left.title]]" 												
									on-click="modstep"
									index$="{{ index }}"
									action="left"									
								></paper-fab>
								<div class="flex"></div>
								<paper-fab
									hidden$="{{ !step.right }}" 
									mini 
									icon="[[right.icon]]" 
									title="[[right.title]]" 												
									on-click="modstep"
									index$="{{ index }}"
									action="right"									
								></paper-fab>							
								<paper-fab mini 
									icon="[[remove.icon]]" 
									title="[[remove.title]]" 												
									on-click="modstep"
									index$="{{ index }}"
									action="remove"									
								></paper-fab>
					    </div>
					  </div>
					</paper-card>
				</template>		
				<paper-card class="with-margin">
				  <div class="card-content">
				  	<paper-input
				    	id="url"
						label="URL"
						on-change="modstep"
						action="add"
					>			
					</paper-input>
				  </div>
				  <div class="card-actions">
				    <div class="layout horizontal">
				    	<div class="flex"></div>					
						<paper-fab mini 
								icon="[[step.icon]]" 
								title="[[step.title]]" 												
								on-click="modstep"
								action="add"
								></paper-fab>								
				    </div>
				  </div>
				</paper-card>				
			</div>
			<paper-item>
				<paper-fab mini 
					icon="[[queue.icon]]" 
					title="[[queue.title]]" 												
					on-click="enqueue"
					disabled$="{{ !enabled }}"
					>
				</paper-fab>
				<paper-fab mini 
					icon="[[serialize.icon]]" 
					title="[[serialize.title]]" 												
					on-click="save"
					disabled$="{{ !enabled }}"
					></paper-fab>
				<paper-fab mini 
					icon="[[clone.icon]]" 
					title="[[clone.title]]" 												
					on-click="copy"
					disabled$="{{ !enabled }}"
					></paper-fab>					
				<paper-fab mini 
					icon="[[publish.icon]]" 
					title="[[publish.title]]" 												
					on-click="share"
					disabled$="{{ !enabled }}"
					></paper-fab>					
			</paper-item>
		</div>      
   </template>   
   <script>
		class MyIndex extends ReduxMixin(Polymer.Element) {
		  static get is() { return 'my-index'; }
	        static get actions() {
	            return {
	         	   websocketRequest(job) {
	                    return {
	                        type: 'WEBSOCKET_REQUEST',
	                        request: job
	                      };					        		   
	         	   }
	            }
	        }
		  static get properties() {
			  return {
	   	             step: {
	   	                 value: {
	   	                         icon: 'add',
	   	                         title: 'Add URL'
	   	                     }
	   	             },
	   	             remove: {
	   	                 value: {
	   	                         icon: 'delete',
	   	                         title: 'Remove URL'
	   	                     }
	   	             },	   	             
	   	          	 queue: {
	   	                 value: {
	   	                         icon: 'av:play-arrow',
	   	                         title: 'Queue'
	   	                     }
	   	             },	   	             
	   	          	 serialize: {
	   	                 value: {
	   	                         icon: 'save',
	   	                         title: 'Save Funnel'
	   	                     }
	   	             },
	   	          	 clone: {
	   	                 value: {
	   	                   icon: 'content-copy',
	   	                   title: 'Copy Funnel'
	   	                 }
	   	             },
	   	          	 publish: {
	   	                 value: {
	   	                   icon: 'social:share',
	   	                   title: 'Export Funnel'
	   	                 }
	   	             },	   	             
	   	          	 right: {
	   	                 type: Object,
	   	                 value: {
	   	                         icon: 'hardware:keyboard-arrow-right',
	   	                         title: 'Save Funnel'
	   	                     }
	   	             },	   	             
	   	          	 left: {
	   	                 type: Object,
	   	                 value: {
	   	                         icon: 'hardware:keyboard-arrow-left',
	   	                         title: 'Save Funnel'
	   	                     }
	   	             },	   	             
	   	             job: {
	   	            	type: Array,
	   	            	value: []
	   	             },	   	             
	   	             enabled: {
	   	            	value: false
		   	         }
			  }
		  }
		  enqueue(e) {
    		   this.dispatch('websocketRequest', {
             	   job: this.job
                })
		  }
		  copy(e) {
   		   	console.log('copy:', e.target)
		  }
		  save(e) {
			console.log('save:', e.target)
		  }
		  share(e) {
			console.log('share:', e.target)
		  }		  
		  modstep(e) {
			  let nj = this.job.slice(0);
			  if ( e.target.getAttribute('action') == 'right' ) {
				  let i = parseInt(e.target.getAttribute('index'));
				  let j = nj[i];
				  nj[i] = nj[i+1];
				  nj[i+1] = j
			  } else if ( e.target.getAttribute('action') == 'left' ) {
				  let i = parseInt(e.target.getAttribute('index'));
				  let j = nj[i];
				  nj[i] = nj[i-1];
				  nj[i-1] = j
			  } else if ( e.target.getAttribute('action') == 'update' ) {
				  let i = parseInt(e.target.getAttribute('index'));
				  let v = e.target.value || 'https://quickbooks.intuit.com';
				  nj[i].url = v;				  
			  } else if ( e.target.getAttribute('action') == 'add' ) {
				  let  v = this.$.url.value || 'https://quickbooks.intuit.com';
				  let step = { 
					 url: v
				  }
				  this.$.url.value = '';
				  nj.push(step)				  	
			  } else if ( e.target.getAttribute('action') == 'remove' ) {
				  let i = parseInt(e.target.getAttribute('index'));
				  nj.splice(i, 1);				  
			  }
			  this.set('job', nj)			  
			  this.job.forEach( (s,i) => {
				  let ns = { url: s.url, right: i < this.job.length - 1, left: i > 0};
				  this.set('job.' + i, ns)				  				  
			  });
			  
			  this.enabled = this.can_run();
		  }
		  can_run() {
			  console.log('can run:', this.job.length)
			  return this.job.length > 0
		  }
		}            
      	customElements.define(MyIndex.is, MyIndex);      
   </script>
</dom-module>