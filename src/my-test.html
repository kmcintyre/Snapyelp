<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="redux-mixin.html">

<dom-module id="my-test">
   <template>
      <style include="shared-styles iron-flex iron-flex-alignment">
         :host {
         }   
         .result {
         	@apply(--layout-vertical);
         }
		 .header {
         	@apply(--layout-horizontal);
         	@apply(--layout-start);
         }
      </style>
      <div class="header">
      	<h3 style="padding: 10px">
      		ID: <b>{{ test.test_id }}</b>
      	</h3>
      	<div class="flex">
	      <div class="results">
		      <template is="dom-repeat" items="{{ test_results(results) }}" as="result">
		      	<div class="layout horizontal">
		      		<div style="padding:2px; width:125px">
	      				{{ result.agent.nickname }}
	      			</div>
	      			<div class="flex">
	      				<template is="dom-repeat" items="{{ result.job }}" as="job">
	      				<div class="job flex layout horizontal">
		      				<div class="flex">
		      					url: {{ job.url }}
		      				</div>
		      				<div style="width: 125px">
		      					load time: {{ format_load_time(job.load_time) }}
		      				</div>
							<div style="width: 100px">
		      					domains: {{ len_domains(job.requests) }}
		      				</div>	      				
							<div style="width: 100px">
		      					requests: {{ len(job.requests) }}
		      				</div>
	      				</div>	      				
	      				</template>	      			
	      			</div>	      			      			
		      	</div>	      		
	      		{{ ts(result) }}
		      </template>      
	      </div>
      	</div>
      	<h3 style="padding: 10px">
      		Results: <b>{{ len_results(results) }}</b>    		      		
      	</h3>      	      	
      </div>
   </template>
   <script>
	class MyTest extends ReduxMixin(Polymer.Element) {
	  static get is() { return 'my-test'; }
	  static get properties() {
		  return {
              test: {
				type: Object
              },
              results: {
				type: Array,
				statePath: 'results'
              }	              
		  }  
	  }
	  format_load_time(f) {
		  return f.toFixed(3);
	  }
	  test_results(results) {
		  var t_id = this.test.test_id;
		  return results.filter(function (r) { return r.test_id == t_id })
	  }
	  test_domains(requests) {
		  var domains = [];
		  requests.forEach(function (r) {
			  console.log(r.url)
			  var hostname = (new URL(r.url)).hostname;
			  if ( domains.indexOf(hostname) == -1 ) {
				  domains.push(hostname)
			  }			   
		  })
		  return domains;
	  }
	  len_domains(requests) {
		  return this.test_domains(requests).length
	  }
	  len_results(results) {
		  return this.test_results(results).length
	  }
	  len(a) {
		  return a.length
	  }	  
	  ts(r) {
		  console.log('result:', r)
	  }
	}            
    customElements.define(MyTest.is, MyTest);      
   </script>
</dom-module>