<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="redux-mixin.html">

<dom-module id="my-test">
   <template>
      <style include="shared-styles iron-flex iron-flex-alignment">
         :host {
         }   
         .result {
         	@apply(--layout-vertical);
         }
		 .header {
         	@apply(--layout-horizontal);         
         }
         h4 {
         	padding: 0 10px 10px 10px
         }
         paper-fab {
         	background-color: #2CA01C;
         }         
      </style>
      <div class="header">
      	<h4>
      		ID: <b>{{ test.test_id }}</b>
      	</h4>
      	<div class="flex">
	      <div class="results">
		      <template is="dom-repeat" items="{{ results }}" as="result">
		      	<div class="layout horizontal">
		      		<div style="padding:2px; width:125px">
	      				{{ result.agent.nickname }}
	      			</div>
	      			<div class="flex">
	      				<template is="dom-repeat" items="{{ result.job }}" as="job">
	      				<div class="job flex layout horizontal">
		      				<div class="flex">
		      					url: {{ job.url }}
		      				</div>
		      				<div style="width: 125px">
		      					load time: {{ format_load_time(job.load_time) }}
		      				</div>
							<div style="width: 100px">
		      					domains: {{ len_domains(job.requests) }}
		      				</div>	      				
							<div style="width: 100px">
		      					requests: {{ len(job.requests) }}
		      				</div>
	      				</div>	      				
	      				</template>	      			
	      			</div>	      			      			
		      	</div>	      		
	      		{{ ts(result) }}
		      </template>      
	      </div>
      	</div>
      	<h4>
      		Results: <b>{{ len_results(results) }}</b>    		      		
      	</h4>      	      	
      	<h4>
      		<paper-item>
				<paper-fab mini 
					icon="[[remove.icon]]" 
					title="[[remove.title]]" 												
					on-click="clear"
					test$="{{ test.test_id }}"
					></paper-fab>   												
			</paper-item>   		      		
      	</h4>      	
      </div>
   </template>
   <script>
	class MyTest extends ReduxMixin(Polymer.Element) {
	  static get is() { return 'my-test'; }
      static get actions() {
          return {
       	   deleteTest(test) {
                  return {
                      type: 'DELETE_TEST',
                      request: test
                    };					        		   
       	   }
          }
      }	  
	  static get properties() {
		  return {
              test: {
				type: Object
              },
              results: {
				type: Array
              },
              remove: {
                 type: Object,
                 value: {
                    icon: 'delete',
                    title: 'Delete Test'
                 }
  	          }              
		  }  
	  }
	  clear(e) {
		  console.log(e.target, e.target.getAttribute('test'))
		  this.dispatch('deleteTest', {
			  test_id: e.target.getAttribute('test')
          })
	  }
	  format_load_time(f) {
		  return f.toFixed(2);
	  }
	  len_domains(requests) {
		  var domains = [];
		  requests.forEach(function (r) {
			  //console.log(r.url)
			  var hostname = (new URL(r.url)).hostname;
			  if ( domains.indexOf(hostname) == -1 ) {
				  domains.push(hostname)
			  }			   
		  })
		  return domains.length;
	  }
	  len_results(results) {
		  return this.results.length
	  }
	  len(a) {
		  return a.length
	  }	  
	  ts(r) {
		  console.log('result:', r)
	  }
	}            
    customElements.define(MyTest.is, MyTest);      
   </script>
</dom-module>